<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOREA SCANNER: GOOGLE PRECISION</title>
  <script src="https://maps.googleapis.com/maps/api/js?v=weekly"></script>
  <style>
    :root { --kr-red: #CD2E3A; --kr-blue: #0047A0; }
    html, body { height: 100%; margin: 0; font-family: 'Malgun Gothic', 'Noto Sans TC', sans-serif; background: #fff; overflow: hidden; }
    #map { height: 100vh; width: 100vw; z-index: 1; }

    /* UI 框架 */
    .header-ui { 
        position: absolute; top: 0; left: 0; width: 100%; height: 320px; 
        background: linear-gradient(to bottom, rgba(255,255,255,0.9) 0%, transparent 100%); 
        z-index: 1001; pointer-events: none;
    }
    .viewport { position: relative; width: 100%; height: 280px; overflow: hidden; }
    .belt { display: flex; position: absolute; left: 50%; top: 40px; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    
    .city-card { 
        width: 240px; padding: 25px; margin-right: 40px; background: #fff; border: 5px solid #000; 
        border-radius: 20px; opacity: 0.1; transform: scale(0.8); transition: 0.5s;
        display: flex; flex-direction: column; align-items: center; flex-shrink: 0;
        box-shadow: 12px 12px 0px #000; position: relative;
    }
    .city-card.active { opacity: 1; transform: scale(1.1); box-shadow: 15px 15px 0px #000; }

    /* 正確的太極 SVG 樣式 */
    .taegeuk-icon { position: absolute; width: 160px; height: 160px; opacity: 0.1; z-index: 0; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    .city-name-ko { font-size: 2.5rem; font-weight: 900; color: #000; z-index: 2; }
    .city-name-cn { font-size: 1.6rem; color: #333; font-weight: bold; z-index: 2; }

    /* 下方數據版 */
    .stats-panel { 
        position: absolute; bottom: 25px; left: 25px; z-index: 1002; background: #fff; 
        padding: 15px 30px; border: 5px solid #000; display: flex; gap: 30px; border-radius: 15px; box-shadow: 8px 8px 0px #000;
    }
    .control-layer { position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%); z-index: 1005; }
    .btn { padding: 15px 50px; font-size: 1.3rem; font-weight: 900; cursor: pointer; border-radius: 20px; border: 4px solid #000; color: #fff; display: none; }
    #confirmBtn { background: var(--kr-red); }
    #nextBtn { background: var(--kr-blue); }

    /* 開頭畫面 */
    .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: #fff; }
    .start-box { text-align: center; border: 8px solid #000; padding: 60px; background: #fff; width: 420px; border-radius: 30px; box-shadow: 25px 25px 0px #000; position: relative; }
    .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--kr-red); animation: scan 3s infinite linear; }
    @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header-ui"><div class="viewport"><div class="belt" id="belt"></div></div></div>
  <div class="stats-panel" id="statsPanel" style="display:none">
    <div id="score" style="font-size:1.5rem; font-weight:900;">SCORE: 0</div>
    <div><span id="progress">0</span> / <span id="total">0</span></div>
  </div>
  <div class="control-layer">
    <button class="btn" id="confirmBtn">CONFIRM [SPACE]</button>
    <button class="btn" id="nextBtn">NEXT [SPACE]</button>
  </div>
  <div id="startModal" class="modal-overlay">
    <div class="start-box">
      <div class="scanner-line"></div>
      <h1 style="font-size: 3.5rem; font-weight: 900; margin:0;">KOREA<br>SCANNER</h1>
      <div id="countDisplay" style="font-size: 6rem; font-weight: 900; margin: 20px 0;">100</div>
      <input type="range" id="citySlider" min="5" max="100" value="100" style="width:100%; accent-color: #000;">
      <button id="startBtn" style="width:100%; padding:20px; background:#000; color:#fff; font-weight:900; border-radius:15px; margin-top:30px; cursor:pointer; font-size:1.5rem; border:none;">START MISSION</button>
    </div>
  </div>

  <script>
    // 預設 100 城市資料 (縮減版示意)
    const DB = [
        {ko:"서울",cn:"首爾",coords:{lat:37.5665,lng:126.9780}},{ko:"부산",cn:"釜山",coords:{lat:35.1796,lng:129.0756}},{ko:"인천",cn:"仁川",coords:{lat:37.4563,lng:126.7052}},{ko:"대구",cn:"大邱",coords:{lat:35.8714,lng:128.6014}},{ko:"대전",cn:"大田",coords:{lat:36.3504,lng:127.3845}},{ko:"광주",cn:"光州",coords:{lat:35.1595,lng:126.8526}},{ko:"울산",cn:"蔚山",coords:{lat:35.5384,lng:129.3114}},{ko:"세종",cn:"世宗",coords:{lat:36.4800,lng:127.2890}},{ko:"수원",cn:"水原",coords:{lat:37.2636,lng:127.0286}},{ko:"제주",cn:"濟州",coords:{lat:33.4996,lng:126.5312}}
        // ... 此處可擴充至 100 個
    ];

    let map, cities=[], idx=0, score=0, currentMarker=null, targetMarker=null, line=null, isAnswered=false;

    // 正確的太極 SVG 字串
    const TAEGEUK_SVG = `
    <svg class="taegeuk-icon" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="50" fill="#0047A0" />
      <path d="M0,50 A50,50 0 0,1 100,50 L50,50 Z" fill="#CD2E3A" />
      <circle cx="25" cy="50" r="25" fill="#CD2E3A" />
      <circle cx="75" cy="50" r="25" fill="#0047A0" />
    </svg>`;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 36.2, lng: 127.8 }, zoom: 7,
            disableDefaultUI: true, styles: [ { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] } ]
        });
        map.addListener("click", (e) => {
            if(isAnswered) return;
            if(currentMarker) currentMarker.setMap(null);
            currentMarker = new google.maps.Marker({ position: e.latLng, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#fff", fillOpacity: 1, strokeWeight: 4, strokeColor: "#000" } });
            document.getElementById('confirmBtn').style.display = 'block';
        });
    }

    document.getElementById('citySlider').oninput = function() { document.getElementById('countDisplay').innerText = this.value; };

    function startMission() {
        const num = parseInt(document.getElementById('citySlider').value);
        cities = DB.sort(() => Math.random() - 0.5).slice(0, num);
        document.getElementById('startModal').style.display = 'none';
        document.getElementById('statsPanel').style.display = 'flex';
        document.getElementById('total').innerText = cities.length;

        const belt = document.getElementById('belt');
        belt.innerHTML = cities.map(c => `<div class="city-card">${TAEGEUK_SVG}<div class="city-name-ko">${c.ko}</div><div class="city-name-cn">${c.cn}</div></div>`).join('');
        refreshRound();
    }

    function refreshRound() {
        isAnswered = false;
        if(currentMarker) currentMarker.setMap(null);
        if(targetMarker) targetMarker.setMap(null);
        if(line) line.setMap(null);
        document.getElementById('confirmBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('progress').innerText = idx + 1;

        const cards = document.querySelectorAll('.city-card');
        cards.forEach(c => c.classList.remove('active'));
        const activeCard = cards[idx];
        activeCard.classList.add('active');
        document.getElementById('belt').style.transform = `translateX(${-activeCard.offsetLeft}px)`;
    }

    function handleConfirm() {
        isAnswered = true;
        document.getElementById('confirmBtn').style.display = 'none';
        const target = cities[idx].coords;
        const clickPos = currentMarker.getPosition();
        const dist = google.maps.geometry.spherical.computeDistanceBetween(clickPos, new google.maps.LatLng(target)) / 1000;
        const pts = Math.round(5000 * Math.pow(Math.E, -dist / 100));
        score += pts;
        document.getElementById('score').innerText = `SCORE: ${score}`;

        targetMarker = new google.maps.Marker({ position: target, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#CD2E3A", fillOpacity: 1, strokeWeight: 4, strokeColor: "#000" } });
        line = new google.maps.Polyline({ path: [clickPos, target], map: map, strokeColor: "#0047A0", strokeOpacity: 0.8, strokeWeight: 6 });
        
        map.panTo(target);
        setTimeout(() => document.getElementById('nextBtn').style.display = 'block', 600);
    }

    window.onload = initMap;
    document.getElementById('startBtn').onclick = startMission;
    document.getElementById('confirmBtn').onclick = handleConfirm;
    document.getElementById('nextBtn').onclick = () => { idx++; if(idx < cities.length) refreshRound(); else location.reload(); };
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') { if(isAnswered) document.getElementById('nextBtn').click(); else if(currentMarker) handleConfirm(); } });
  </script>
</body>
</html>
