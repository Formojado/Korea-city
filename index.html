<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOREA SCANNER: NEON LASER</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --laser-cyan: #00f2ff;
      --laser-glow: rgba(0, 242, 255, 0.6);
      --bg-dark: rgba(0, 0, 0, 0.85);
      --g-red: #EA4335;
      --g-green: #34A853;
    }

    html, body { height: 100%; margin: 0; font-family: 'PingFang SC', sans-serif; background: #000; overflow: hidden; }
    #map { height: 100vh; width: 100vw; z-index: 1; }

    /* UI 頂部容器 */
    .header-ui { 
        position: absolute; top: 0; left: 0; width: 100%; height: 220px; 
        background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); 
        z-index: 1001; pointer-events: none; display: flex; flex-direction: column; align-items: center;
    }

    .conveyor-viewport { width: 100%; height: 160px; overflow: hidden; position: relative; margin-top: 20px; }
    .conveyor-belt { display: flex; align-items: center; position: absolute; left: 50%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); height: 100%; }
    
    /* 雷射邊框卡片設計 */
    .city-card { 
        min-width: 260px; padding: 15px; margin: 0 10px;
        background: var(--bg-dark);
        border: 2px solid var(--laser-cyan);
        box-shadow: 0 0 15px var(--laser-glow), inset 0 0 10px var(--laser-glow);
        border-radius: 8px;
        opacity: 0.1; transform: scale(0.8); transition: 0.5s;
        display: flex; flex-direction: column; align-items: center;
    }
    .city-card.active { 
        opacity: 1; transform: scale(1.1); 
        animation: pulse 1.5s infinite alternate;
    }

    @keyframes pulse {
        from { box-shadow: 0 0 15px var(--laser-glow), inset 0 0 10px var(--laser-glow); }
        to { box-shadow: 0 0 30px var(--laser-cyan), inset 0 0 15px var(--laser-cyan); }
    }
    
    /* 白色霓虹字體 */
    .neon-text {
        color: #fff !important;
        text-shadow: 0 0 5px #fff, 0 0 10px var(--laser-cyan), 0 0 20px var(--laser-cyan);
        margin: 2px 0;
        font-weight: 900;
        text-align: center;
    }
    .city-name-ko { font-size: 2rem; }
    .city-name-cn { font-size: 1.4rem; }
    .city-name-en { font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.9; }

    /* 按鈕與統計面板保持清晰 */
    .stats-panel { 
        position: absolute; bottom: 25px; left: 25px; z-index: 1002; 
        background: var(--bg-dark); padding: 15px 30px; border: 1px solid var(--laser-cyan);
        display: flex; gap: 40px; border-radius: 4px; box-shadow: 0 0 10px var(--laser-glow);
    }
    .stat-val { font-family: 'Courier New', monospace; font-size: 1.8rem; color: #fff; font-weight: bold; text-shadow: 0 0 5px var(--laser-cyan); }
    
    .control-layer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 1005; }
    .btn { 
        padding: 15px 60px; font-size: 1.3rem; font-weight: 900; cursor: pointer; 
        border-radius: 50px; border: none; color: #fff; text-shadow: 0 0 5px #fff;
    }
    #confirmBtn { background: var(--laser-cyan); color: #000; display: none; box-shadow: 0 0 20px var(--laser-cyan); }
    #nextBtn { background: var(--g-green); display: none; box-shadow: 0 0 20px var(--g-green); }

    .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: #000; }
    .start-box { 
        text-align: center; border: 2px solid var(--laser-cyan); padding: 50px; 
        background: var(--bg-dark); width: 400px; border-radius: 12px; box-shadow: 0 0 30px var(--laser-glow);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header-ui">
    <div class="conveyor-viewport" id="viewport" style="display:none">
        <div class="conveyor-belt" id="belt"></div>
    </div>
  </div>
  
  <div class="stats-panel" id="statsPanel" style="display:none">
    <div id="score" class="stat-val">0</div>
    <div class="stat-val"><span id="progress">0</span> / <span id="total">0</span></div>
  </div>

  <div class="control-layer">
    <button class="btn" id="confirmBtn">LOCK IN 確認座標</button>
    <button class="btn" id="nextBtn">NEXT TARGET 下一題 ❯</button>
  </div>

  <div id="startModal" class="modal-overlay">
    <div class="start-box">
      <h1 class="neon-text" style="font-size: 2.5rem; margin-bottom: 20px;">KOREA SCANNER</h1>
      <div id="countDisplay" class="neon-text" style="font-size: 5rem; margin: 20px 0;">100</div>
      <input type="range" id="citySlider" min="5" max="100" value="100" style="width:100%; accent-color:var(--laser-cyan);">
      <button id="startBtn" style="width:100%; padding:20px; background:var(--laser-cyan); color:#000; font-weight:900; border:none; border-radius:8px; margin-top:30px; cursor:pointer; font-size:1.2rem;">INITIALIZE SCAN</button>
    </div>
  </div>

  <script>
    // 使用之前提供的 100 個城市數據
    const DB = [
        {ko:"서울",en:"Seoul",cn:"首爾",coords:[37.5665,126.9780]},{ko:"부산",en:"Busan",cn:"釜山",coords:[35.1796,129.0756]},{ko:"인천",en:"Incheon",cn:"仁川",coords:[37.4563,126.7052]},{ko:"대구",en:"Daegu",cn:"大邱",coords:[35.8714,128.6014]},{ko:"대전",en:"Daejeon",cn:"大田",coords:[36.3504,127.3845]},{ko:"광주",en:"Gwangju",cn:"光州",coords:[35.1595,126.8526]},{ko:"울산",en:"Ulsan",cn:"蔚山",coords:[35.5384,129.3114]},{ko:"세종",en:"Sejong",cn:"世宗",coords:[36.4800,127.2890]},{ko:"수원",en:"Suwon",cn:"水原",coords:[37.2636,127.0286]},{ko:"고양",en:"Goyang",cn:"高陽",coords:[37.6584,126.8320]},{ko:"용인",en:"Yongin",cn:"龍仁",coords:[37.2410,127.1779]},{ko:"성남",en:"Seongnam",cn:"城南",coords:[37.4200,127.1265]},{ko:"창원",en:"Changwon",cn:"昌原",coords:[35.2280,128.6811]},{ko:"청주",en:"Cheongju",cn:"清州",coords:[36.6424,127.4890]},{ko:"전주",en:"Jeonju",cn:"全州",coords:[35.8242,127.1480]},{ko:"천안",en:"Cheonan",cn:"天安",coords:[36.8151,127.1139]},{ko:"안산",en:"Ansan",cn:"安山",coords:[37.3219,126.8308]},{ko:"남양주",en:"Namyangju",cn:"南楊州",coords:[37.6360,127.2165]},{ko:"화성",en:"Hwaseong",cn:"華城",coords:[37.1995,126.8312]},{ko:"안양",en:"Anyang",cn:"安養",coords:[37.3943,126.9568]},{ko:"김해",en:"Gimhae",cn:"金海",coords:[35.2358,128.8817]},{ko:"포항",en:"Pohang",cn:"浦項",coords:[36.0190,129.3435]},{ko:"平澤",en:"Pyeongtaek",cn:"平澤",coords:[36.9921,127.1128]},{ko:"제주",en:"Jeju",cn:"濟州",coords:[33.4996,126.5312]},{ko:"議政府",en:"Uijeongbu",cn:"議政府",coords:[37.7381,127.0337]},{ko:"坡州",en:"Paju",cn:"坡州",coords:[37.7600,126.7800]},{ko:"始興",en:"Siheung",cn:"始興",coords:[37.3800,126.8034]},{ko:"金浦",en:"Gimpo",cn:"金浦",coords:[37.6151,126.7153]},{ko:"晉州",en:"Jinju",cn:"晉州",coords:[35.1798,128.1076]},{ko:"光明",en:"Gwangmyeong",cn:"光明",coords:[37.4785,126.8646]},{ko:"原州",en:"Wonju",cn:"原州",coords:[37.3422,127.9202]},{ko:"牙山",en:"Asan",cn:"牙山",coords:[36.7898,127.0017]},{ko:"益山",en:"Iksan",cn:"益山",coords:[35.9483,126.9576]},{ko:"梁山",en:"Yangsan",cn:"梁山",coords:[35.3385,129.0371]},{ko:"軍浦",en:"Gunpo",cn:"軍浦",coords:[37.3617,126.9353]},{ko:"群山",en:"Gunsan",cn:"群山",coords:[35.9676,126.7366]},{ko:"慶州",en:"Gyeongju",cn:"慶州",coords:[35.8562,129.2247]},{ko:"慶山",en:"Gyeongsan",cn:"慶山",coords:[35.8250,128.7413]},{ko:"麗水",en:"Yeosu",cn:"麗水",coords:[34.7604,127.6622]},{ko:"順天",en:"Suncheon",cn:"順天",coords:[34.9506,127.4872]},{ko:"巨濟",en:"Geoje",cn:"巨濟",coords:[34.8806,128.6211]},{ko:"木浦",en:"Mokpo",cn:"木浦",coords:[34.8118,126.3922]},{ko:"江陵",en:"Gangneung",cn:"江陵",coords:[37.7519,128.8761]},{ko:"烏山",en:"Osan",cn:"烏山",coords:[37.1498,127.0776]},{ko:"忠州",en:"Chungju",cn:"忠州",coords:[36.9910,127.9259]},{ko:"利川",en:"Icheon",cn:"利川",coords:[37.2723,127.4351]},{ko:"楊州",en:"Yangju",cn:"楊州",coords:[37.7853,127.0457]},{ko:"安城",en:"Anseong",cn:"安城",coords:[37.0080,127.2798]},{ko:"九里",en:"Guri",cn:"九里",coords:[37.5943,127.1296]},{ko:"瑞山",en:"Seosan",cn:"瑞山",coords:[36.7845,126.4504]},{ko:"唐津",en:"Dangjin",cn:"唐津",coords:[36.8898,126.6274]},{ko:"安東",en:"Andong",cn:"安東",coords:[36.5684,128.7294]},{ko:"抱川",en:"Pocheon",cn:"抱川",coords:[37.8949,127.2003]},{ko:"儀王",en:"Uiwang",cn:"儀王",coords:[37.3448,126.9683]},{ko:"河南",en:"Hanam",cn:"河南",coords:[37.5392,127.2148]},{ko:"光陽",en:"Gwangyang",cn:"光陽",coords:[34.9407,127.6908]},{ko:"金泉",en:"Gimcheon",cn:"金泉",coords:[36.1394,128.1136]},{ko:"統營",en:"Tongyeong",cn:"統營",coords:[34.8544,128.4331]},{ko:"堤川",en:"Jecheon",cn:"堤川",coords:[37.1326,128.2141]},{ko:"論山",en:"Nonsan",cn:"論山",coords:[36.1871,127.0984]},{ko:"公州",en:"Gongju",cn:"公州",coords:[36.4465,127.1190]},{ko:"泗川",en:"Sacheon",cn:"泗川",coords:[35.0039,128.0642]},{ko:"井邑",en:"Jeongeup",cn:"井邑",coords:[35.5699,126.8573]},{ko:"榮州",en:"Yeongju",cn:"榮州",coords:[36.8056,128.6240]},{ko:"密陽",en:"Miryang",cn:"密陽",coords:[35.5038,128.7466]},{ko:"尚州",en:"Sangju",cn:"尚州",coords:[36.4109,128.1591]},{ko:"保寧",en:"Boryeong",cn:"保寧",coords:[36.3333,126.6122]},{ko:"永川",en:"Yeongcheon",cn:"永川",coords:[35.9733,128.9388]},{ko:"東豆川",en:"Dongducheon",cn:"東豆川",coords:[37.9036,127.0607]},{ko:"東海",en:"Donghae",cn:"東海",coords:[37.5244,129.1143]},{ko:"金堤",en:"Gimje",cn:"金堤",coords:[35.8032,126.8808]},{ko:"束草",en:"Sokcho",cn:"束草",coords:[38.2070,128.5918]},{ko:"南原",en:"Namwon",cn:"南原",coords:[35.4164,127.3904]},{ko:"羅州",en:"Naju",cn:"羅州",coords:[35.0158,126.7108]},{ko:"聞慶",en:"Mungyeong",cn:"聞慶",coords:[36.5861,128.1868]},{ko:"三陟",en:"Samcheok",cn:"三陟",coords:[37.4498,129.1648]},{ko:"果川",en:"Gwacheon",cn:"果川",coords:[37.4292,126.9899]},{ko:"太白",en:"Taebaek",cn:"太白",coords:[37.1641,128.9856]},{ko:"雞龍",en:"Gyeryong",cn:"雞龍",coords:[36.2746,127.2486]},{ko:"西歸浦",en:"Seogwipo",cn:"西歸浦",coords:[33.2541,126.5601]},{ko:"楊平",en:"Yangpyeong",cn:"楊平",coords:[37.4917,127.4875]},{ko:"洪城",en:"Hongseong",cn:"洪城",coords:[36.6013,126.6608]},{ko:"예산",en:"Yesan",cn:"禮山",coords:[36.6811,126.8465]},{ko:"부여",en:"Buyeo",cn:"扶餘",coords:[36.2747,126.9125]},{ko:"태안",en:"Taean",cn:"泰安",coords:[36.7544,126.2981]},{ko:"음성",en:"Eumseong",cn:"陰城",coords:[36.9402,127.6905]},{ko:"진천",en:"Jincheon",cn:"鎮川",coords:[36.8553,127.4387]},{ko:"가평",en:"Gapyeong",cn:"加平",coords:[37.8315,127.5095]},{ko:"연천",en:"Yeoncheon",cn:"漣川",coords:[38.0964,127.0754]},{ko:"홍천",en:"Hongcheon",cn:"洪川",coords:[37.6975,127.8887]},{ko:"횡성",en:"Hoengseong",cn:"橫城",coords:[37.4918,127.9850]},{ko:"평창",en:"Pyeongchang",cn:"平昌",coords:[37.3705,128.3903]},{ko:"정선",en:"Jeongseon",cn:"旌善",coords:[37.3807,128.6608]},{ko:"철원",en:"Cheorwon",cn:"鐵原",coords:[38.1465,127.3134]},{ko:"화천",en:"Hwacheon",cn:"華川",coords:[38.1057,127.7082]},{ko:"인제",en:"Inje",cn:"麟蹄",coords:[38.0697,128.1703]},{ko:"고성",en:"Goseong",cn:"高城",coords:[38.3805,128.4687]},{ko:"울진",en:"Uljin",cn:"蔚珍",coords:[36.9930,129.4005]},{ko:"영덕",en:"Yeongdeok",cn:"盈德",coords:[36.4150,129.3658]},{ko:"칠곡",en:"Chilgok",cn:"漆谷",coords:[35.9958,128.4017]}
    ];

    let cities=[], idx=0, score=0, currentClick=null;
    let pMarker=null, tMarker=null, line=null, isAnswered=false;

    const map = L.map('map',{zoomControl:false, attributionControl:false}).setView([36.2, 127.8], 7);
    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}').addTo(map);

    document.getElementById('citySlider').oninput = function() {
        document.getElementById('countDisplay').innerText = this.value;
    };

    function startScan() {
        const num = parseInt(document.getElementById('citySlider').value);
        cities = [...DB].sort(() => Math.random() - 0.5).slice(0, num);
        
        document.getElementById('startModal').style.display = 'none';
        document.getElementById('viewport').style.display = 'block';
        document.getElementById('statsPanel').style.display = 'flex';
        document.getElementById('total').innerText = cities.length;

        const belt = document.getElementById('belt');
        belt.innerHTML = cities.map(c => `
            <div class="city-card">
                <div class="neon-text city-name-ko">${c.ko}</div>
                <div class="neon-text city-name-cn">${c.cn}</div>
                <div class="neon-text city-name-en">${c.en}</div>
            </div>
        `).join('');

        refreshRound();
    }

    function refreshRound() {
        isAnswered = false;
        currentClick = null;
        if(pMarker) map.removeLayer(pMarker);
        if(tMarker) map.removeLayer(tMarker);
        if(line) map.removeLayer(line);

        document.getElementById('confirmBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('progress').innerText = idx + 1;
        
        document.getElementById('belt').style.transform = `translateX(${-(idx * 280) - 140}px)`;
        const cards = document.querySelectorAll('.city-card');
        cards.forEach((c, i) => c.classList.toggle('active', i === idx));
        
        map.flyTo([36.2, 127.8], 7);
    }

    map.on('click', e => {
        if(isAnswered) return;
        currentClick = e.latlng;
        if(pMarker) map.removeLayer(pMarker);
        pMarker = L.circleMarker(e.latlng, {radius:12, color:'#fff', fillColor: '#EA4335', weight:3, fillOpacity:1}).addTo(map);
        document.getElementById('confirmBtn').style.display = 'block';
    });

    function handleConfirm() {
        if(!currentClick || isAnswered) return;
        isAnswered = true;
        document.getElementById('confirmBtn').style.display = 'none';

        const target = cities[idx];
        const dist = map.distance(currentClick, target.coords) / 1000;
        const pts = Math.round(5000 * Math.pow(Math.E, -dist / 100));

        const pix = map.latLngToContainerPoint(currentClick);
        const burst = document.createElement('div');
        burst.className = 'neon-text';
        burst.style.position = 'fixed';
        burst.style.fontSize = '4rem';
        burst.style.left = pix.x + 'px'; burst.style.top = pix.y + 'px';
        burst.style.zIndex = '9999';
        burst.innerText = `+${pts}`;
        document.body.appendChild(burst);
        
        // 簡單動畫
        burst.animate([
            { transform: 'scale(0.5) translateY(0)', opacity: 1 },
            { transform: 'scale(1.5) translateY(-100px)', opacity: 0 }
        ], { duration: 1200, easing: 'ease-out' }).onfinish = () => burst.remove();

        tMarker = L.circleMarker(target.coords, {radius:14, color:'#fff', fillColor:'#34A853', weight:3, fillOpacity:1}).addTo(map);
        line = L.polyline([currentClick, target.coords], {color: 'var(--laser-cyan)', weight:3, dashArray:'10,10'}).addTo(map);
        
        score += pts;
        document.getElementById('score').innerText = score.toLocaleString();
        
        map.flyTo(target.coords, 10);
        setTimeout(() => document.getElementById('nextBtn').style.display = 'block', 1000);
    }

    function handleNext() {
        idx++;
        if(idx < cities.length) refreshRound();
        else { alert("SCAN COMPLETE! TOTAL SCORE: " + score); location.reload(); }
    }

    document.getElementById('startBtn').onclick = startScan;
    document.getElementById('confirmBtn').onclick = handleConfirm;
    document.getElementById('nextBtn').onclick = handleNext;

    window.onkeydown = e => {
        if(e.code === 'Space') {
            if(document.getElementById('confirmBtn').style.display === 'block') handleConfirm();
            else if(document.getElementById('nextBtn').style.display === 'block') handleNext();
        }
    };
  </script>
</body>
</html>
