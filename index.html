<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEO-SCANNER KOREA: 100 NODES</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --neon-blue: #00d2ff;
      --korea-red: #ff3366;
      --korea-blue: #3366ff;
      --bg: #05070a;
    }

    html, body { height: 100%; margin: 0; font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; background: var(--bg); overflow: hidden; }
    #map { height: 100vh; width: 100vw; z-index: 1; filter: brightness(0.8) contrast(1.2); }

    .header-ui { 
        position: absolute; top: 0; left: 0; width: 100%; height: 160px; 
        background: linear-gradient(to bottom, rgba(5, 7, 10, 0.9) 0%, rgba(5, 7, 10, 0) 100%); 
        z-index: 1001; pointer-events: none; display: flex; flex-direction: column; align-items: center;
    }

    .conveyor-viewport { width: 100%; height: 110px; overflow: hidden; position: relative; margin-top: 10px; }
    .conveyor-belt { display: flex; align-items: center; position: absolute; left: 50%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); height: 100%; }
    
    .city-card { min-width: 240px; text-align: center; opacity: 0.1; transform: scale(0.8); transition: 0.5s; }
    .city-card.active { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 15px var(--neon-blue)); }
    
    .city-name-ko { font-size: 2.8rem; font-weight: 900; color: #fff; line-height: 1; margin-bottom: 2px; }
    .city-name-en { font-size: 0.9rem; color: var(--neon-blue); letter-spacing: 2px; font-weight: bold; text-transform: uppercase; }

    .score-burst { position: fixed; pointer-events: none; color: #fff; font-size: 3.5rem; font-weight: 900; z-index: 9999; animation: burst 1.2s forwards; text-shadow: 0 0 10px var(--neon-blue); }
    @keyframes burst { 0% { transform: scale(0); opacity: 0; } 30% { opacity: 1; transform: scale(1.2); } 100% { transform: translate(var(--tx), var(--ty)); opacity: 0; } }

    .stats-panel { 
        position: absolute; bottom: 25px; left: 25px; z-index: 1002; 
        background: rgba(0, 0, 0, 0.8); padding: 15px 30px; border-top: 3px solid var(--korea-red);
        display: flex; gap: 40px; backdrop-filter: blur(10px);
    }
    .stat-label { color: var(--neon-blue); font-size: 0.7rem; letter-spacing: 1px; }
    .stat-val { font-family: 'Courier New', monospace; font-size: 1.8rem; color: #fff; font-weight: bold; }
    
    #confirmContainer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 1005; display: none; }
    .btn-confirm { background: #fff; color: #000; border: none; padding: 15px 50px; font-size: 1.2rem; font-weight: 900; cursor: pointer; border-radius: 4px; letter-spacing: 2px; }

    .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: #000; }
    .start-box { text-align: center; border: 1px solid rgba(255,255,255,0.2); padding: 50px; width: 400px; }
    input[type=range] { width: 100%; accent-color: var(--korea-red); cursor: pointer; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header-ui">
    <div class="conveyor-viewport" id="viewport" style="display:none">
        <div class="conveyor-belt" id="belt"></div>
    </div>
  </div>
  
  <div class="stats-panel" id="statsPanel" style="display:none">
    <div><div class="stat-label">SCORE</div><div id="score" class="stat-val">0</div></div>
    <div><div class="stat-label">TARGET</div><div class="stat-val"><span id="progress">0</span> / <span id="total">0</span></div></div>
  </div>

  <div id="confirmContainer"><button class="btn-confirm" id="confirmBtn">CONFIRM TARGET</button></div>

  <div id="startModal" class="modal-overlay">
    <div class="start-box">
      <h1 style="color:#fff; letter-spacing:5px; margin-bottom:10px;">KOREA SCANNER</h1>
      <p style="color:var(--neon-blue); margin-bottom:30px;">SOUTH KOREA GEOLOCATION DATA</p>
      <div style="font-size: 5rem; color:#fff; font-weight:900;" id="countDisplay">50</div>
      <input type="range" id="citySlider" min="5" max="100" value="50">
      <button id="startBtn" style="width:100%; padding:20px; background:var(--korea-red); color:#fff; font-weight:900; cursor:pointer; border:none; margin-top:30px;">INITIALIZE SCAN</button>
    </div>
  </div>

  <script>
    // 韓國 100 個城市數據庫 (含首爾、廣域市、道轄市、重要郡)
    const DB = [
        {ko:"서울",en:"Seoul",coords:[37.5665,126.9780]},{ko:"부산",en:"Busan",coords:[35.1796,129.0756]},{ko:"인천",en:"Incheon",coords:[37.4563,126.7052]},{ko:"대구",en:"Daegu",coords:[35.8714,128.6014]},{ko:"대전",en:"Daejeon",coords:[36.3504,127.3845]},{ko:"광주",en:"Gwangju",coords:[35.1595,126.8526]},{ko:"울산",en:"Ulsan",coords:[35.5384,129.3114]},{ko:"세종",en:"Sejong",coords:[36.4800,127.2890]},{ko:"수원",en:"Suwon",coords:[37.2636,127.0286]},{ko:"고양",en:"Goyang",coords:[37.6584,126.8320]},{ko:"용인",en:"Yongin",coords:[37.2410,127.1779]},{ko:"성남",en:"Seongnam",coords:[37.4200,127.1265]},{ko:"창원",en:"Changwon",coords:[35.2280,128.6811]},{ko:"청주",en:"Cheongju",coords:[36.6424,127.4890]},{ko:"전주",en:"Jeonju",coords:[35.8242,127.1480]},{ko:"천안",en:"Cheonan",coords:[36.8151,127.1139]},{ko:"안산",en:"Ansan",coords:[37.3219,126.8308]},{ko:"남양주",en:"Namyangju",coords:[37.6360,127.2165]},{ko:"화성",en:"Hwaseong",coords:[37.1995,126.8312]},{ko:"안양",en:"Anyang",coords:[37.3943,126.9568]},{ko:"김해",en:"Gimhae",coords:[35.2358,128.8817]},{ko:"포항",en:"Pohang",coords:[36.0190,129.3435]},{ko:"평택",en:"Pyeongtaek",coords:[36.9921,127.1128]},{ko:"제주",en:"Jeju",coords:[33.4996,126.5312]},{ko:"의정부",en:"Uijeongbu",coords:[37.7381,127.0337]},{ko:"파주",en:"Paju",coords:[37.7600,126.7800]},{ko:"시흥",en:"Siheung",coords:[37.3800,126.8034]},{ko:"김포",en:"Gimpo",coords:[37.6151,126.7153]},{ko:"진주",en:"Jinju",coords:[35.1798,128.1076]},{ko:"광명",en:"Gwangmyeong",coords:[37.4785,126.8646]},{ko:"원주",en:"Wonju",coords:[37.3422,127.9202]},{ko:"아산",en:"Asan",coords:[36.7898,127.0017]},{ko:"익산",en:"Iksan",coords:[35.9483,126.9576]},{ko:"양산",en:"Yangsan",coords:[35.3385,129.0371]},{ko:"군포",en:"Gunpo",coords:[37.3617,126.9353]},{ko:"군산",en:"Gunsan",coords:[35.9676,126.7366]},{ko:"경주",en:"Gyeongju",coords:[35.8562,129.2247]},{ko:"경산",en:"Gyeongsan",coords:[35.8250,128.7413]},{ko:"여수",en:"Yeosu",coords:[34.7604,127.6622]},{ko:"순천",en:"Suncheon",coords:[34.9506,127.4872]},{ko:"거제",en:"Geoje",coords:[34.8806,128.6211]},{ko:"목포",en:"Mokpo",coords:[34.8118,126.3922]},{ko:"강릉",en:"Gangneung",coords:[37.7519,128.8761]},{ko:"오산",en:"Osan",coords:[37.1498,127.0776]},{ko:"충주",en:"Chungju",coords:[36.9910,127.9259]},{ko:"이천",en:"Icheon",coords:[37.2723,127.4351]},{ko:"양주",en:"Yangju",coords:[37.7853,127.0457]},{ko:"안성",en:"Anseong",coords:[37.0080,127.2798]},{ko:"구리",en:"Guri",coords:[37.5943,127.1296]},{ko:"서산",en:"Seosan",coords:[36.7845,126.4504]},{ko:"당진",en:"Dangjin",coords:[36.8898,126.6274]},{ko:"안동",en:"Andong",coords:[36.5684,128.7294]},{ko:"포천",en:"Pocheon",coords:[37.8949,127.2003]},{ko:"의왕",en:"Uiwang",coords:[37.3448,126.9683]},{ko:"하남",en:"Hanam",coords:[37.5392,127.2148]},{ko:"광양",en:"Gwangyang",coords:[34.9407,127.6908]},{ko:"김천",en:"Gimcheon",coords:[36.1394,128.1136]},{ko:"통영",en:"Tongyeong",coords:[34.8544,128.4331]},{ko:"제천",en:"Jecheon",coords:[37.1326,128.2141]},{ko:"논산",en:"Nonsan",coords:[36.1871,127.0984]},{ko:"공주",en:"Gongju",coords:[36.4465,127.1190]},{ko:"사천",en:"Sacheon",coords:[35.0039,128.0642]},{ko:"정읍",en:"Jeongeup",coords:[35.5699,126.8573]},{ko:"영주",en:"Yeongju",coords:[36.8056,128.6240]},{ko:"밀양",en:"Miryang",coords:[35.5038,128.7466]},{ko:"상주",en:"Sangju",coords:[36.4109,128.1591]},{ko:"보령",en:"Boryeong",coords:[36.3333,126.6122]},{ko:"영천",en:"Yeongcheon",coords:[35.9733,128.9388]},{ko:"동두천",en:"Dongducheon",coords:[37.9036,127.0607]},{ko:"동해",en:"Donghae",coords:[37.5244,129.1143]},{ko:"김제",en:"Gimje",coords:[35.8032,126.8808]},{ko:"속초",en:"Sokcho",coords:[38.2070,128.5918]},{ko:"남원",en:"Namwon",coords:[35.4164,127.3904]},{ko:"나주",en:"Naju",coords:[35.0158,126.7108]},{ko:"문경",en:"Mungyeong",coords:[36.5861,128.1868]},{ko:"삼척",en:"Samcheok",coords:[37.4498,129.1648]},{ko:"과천",en:"Gwacheon",coords:[37.4292,126.9899]},{ko:"태백",en:"Taebaek",coords:[37.1641,128.9856]},{ko:"계룡",en:"Gyeryong",coords:[36.2746,127.2486]},{ko:"서귀포",en:"Seogwipo",coords:[33.2541,126.5601]},{ko:"양평",en:"Yangpyeong",coords:[37.4917,127.4875]},{ko:"홍성",en:"Hongseong",coords:[36.6013,126.6608]},{ko:"예산",en:"Yesan",coords:[36.6811,126.8465]},{ko:"부여",en:"Buyeo",coords:[36.2747,126.9125]},{ko:"태안",en:"Taean",coords:[36.7544,126.2981]},{ko:"음성",en:"Eumseong",coords:[36.9402,127.6905]},{ko:"진천",en:"Jincheon",coords:[36.8553,127.4387]},{ko:"가평",en:"Gapyeong",coords:[37.8315,127.5095]},{ko:"연천",en:"Yeoncheon",coords:[38.0964,127.0754]},{ko:"홍천",en:"Hongcheon",coords:[37.6975,127.8887]},{ko:"횡성",en:"Hoengseong",coords:[37.4918,127.9850]},{ko:"평창",en:"Pyeongchang",coords:[37.3705,128.3903]},{ko:"정선",en:"Jeongseon",coords:[37.3807,128.6608]},{ko:"철원",en:"Cheorwon",coords:[38.1465,127.3134]},{ko:"화천",en:"Hwacheon",coords:[38.1057,127.7082]},{ko:"인제",en:"Inje",coords:[38.0697,128.1703]},{ko:"고성",en:"Goseong",coords:[38.3805,128.4687]},{ko:"울진",en:"Uljin",coords:[36.9930,129.4005]},{ko:"영덕",en:"Yeongdeok",coords:[36.4150,129.3658]},{ko:"칠곡",en:"Chilgok",coords:[35.9958,128.4017]}
    ];

    let cities=[], idx=0, score=0, started=false, isProcessing=false;
    let currentClickPos = null, playerMarker = null, targetMarker = null, connectorLine = null;

    const map = L.map('map',{zoomControl:false, attributionControl:false}).setView([36.5, 127.8], 7);
    
    // 使用乾淨的街道底圖
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const slider = document.getElementById('citySlider');
    slider.oninput = () => document.getElementById('countDisplay').textContent = slider.value;

    function startGame() {
        const count = Math.min(parseInt(slider.value), DB.length);
        cities = [...DB].sort(() => Math.random() - 0.5).slice(0, count);

        document.getElementById('total').textContent = cities.length;
        document.getElementById('startModal').style.display = 'none';
        document.getElementById('viewport').style.display = 'block';
        document.getElementById('statsPanel').style.display = 'flex';
        
        const belt = document.getElementById('belt');
        belt.innerHTML = cities.map(c => `<div class="city-card"><div class="city-name-ko">${c.ko}</div><div class="city-name-en">${c.en}</div></div>`).join('');
        started = true;
        updateConveyor();
    }

    function updateConveyor() {
        document.getElementById('belt').style.transform = `translateX(${-(idx * 240) - 120}px)`;
        const cards = document.querySelectorAll('.city-card');
        cards.forEach((card, i) => card.classList.toggle('active', i === idx));
        document.getElementById('progress').textContent = idx + 1;
        isProcessing = false;
    }

    map.on('click', e => {
        if(!started || isProcessing) return;
        currentClickPos = e.latlng;
        if(playerMarker) map.removeLayer(playerMarker);
        playerMarker = L.circleMarker(e.latlng, {
            radius: 12, color: '#fff', fillColor: '#ff3366', weight: 4, fillOpacity: 1
        }).addTo(map);
        document.getElementById('confirmContainer').style.display = 'block';
    });

    function submitAnswer() {
        if(!started || !currentClickPos || isProcessing) return;
        isProcessing = true;
        document.getElementById('confirmContainer').style.display = 'none';

        const city = cities[idx];
        const dist = map.distance(currentClickPos, city.coords) / 1000;
        // 韓國國土較小，距離懲罰更嚴格 (分母改為 150)
        const points = Math.round(5000 * Math.pow(Math.E, -dist / 150));
        
        map.flyTo(currentClickPos, 9, { duration: 0.5 });

        setTimeout(() => {
            burstScore(points);
            targetMarker = L.circleMarker(city.coords, {
                radius: 14, color: '#fff', fillColor: '#00d2ff', weight: 4, fillOpacity: 1
            }).addTo(map);
            connectorLine = L.polyline([currentClickPos, city.coords], {color: 'rgba(255,255,255,0.5)', weight: 2, dashArray: '5, 10'}).addTo(map);
            
            score += points;
            document.getElementById('score').textContent = score.toLocaleString();
            map.flyTo(city.coords, 11, { duration: 0.8 });
        }, 600);

        setTimeout(() => {
            idx++;
            if(playerMarker) map.removeLayer(playerMarker);
            if(targetMarker) map.removeLayer(targetMarker);
            if(connectorLine) map.removeLayer(connectorLine);
            
            if(idx < cities.length) { 
                updateConveyor(); 
                map.flyTo([36.5, 127.8], 7, { duration: 0.7 }); 
            } else { 
                alert("KOREA SCAN COMPLETE!\nTOTAL SCORE: " + score); 
                location.reload(); 
            }
        }, 2800);
    }

    function burstScore(pts) {
        const screenPos = map.latLngToContainerPoint(currentClickPos);
        const div = document.createElement('div');
        div.className = 'score-burst';
        div.style.left = screenPos.x + 'px';
        div.style.top = screenPos.y + 'px';
        div.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px');
        div.style.setProperty('--ty', (-150) + 'px');
        div.textContent = `+${pts}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('confirmBtn').onclick = submitAnswer;

    window.addEventListener('keydown', e => {
        if(e.code === 'Space' && document.getElementById('confirmContainer').style.display === 'block') {
            e.preventDefault(); submitAnswer();
        }
    });
  </script>
</body>
</html>
